 ## 登录流程

```
先wx.checkSession检查登录态是否过期
1.wx.login()获取返回的code
2.wx.request()把code发送给后端
3.后端拿着appid,appsecret,code请求微信接口服务
4.微信后台返回session_key，openid等给后端，然后再返回token给前端
5.前端拿到token后记录用户的登录状态，登录成功
```

**session_key用来解密微信加密数据，不能明文传给前端**

## 登录

```
wx.checkSession({     //检查登录态session_key是否过期
	success: function(res) {
		if(res.errMsg === "checkSession:ok" && wx.getStorageSync('token')){   //getStorageSync()同步的方法
			//session没有过期并且本地缓存有token，也就是token没有过期，
			//不用调用登录接口获取token
		}else{
			//session过期，调用wx.login()获取code(登录凭证，有效期限5分钟),传给后端
			
			1. wx.login({
			  success: (result) => {
				console.log(result)  //有返回code，可以传给后端
				if(result.code){
					
				  2. wx.request({
					url: 'url',
					data:{'code':result.code},
					success(res){
						const result = res.date;
						//会拿到后端返回的token
						
						3. wx.setStorage({   //把token存到本地
							key: 'token',
							data: result.data.token
						 })
						 
					}
				  })
				  
				}
			  },
			  fail: (res) => {},
			  complete: (res) => {},
			})
			
		}
	}
	
})
```

## button点击授权，获取用户信息

```
填写open-type="getUserInfo"才会有弹窗询问是否允许获取你的信息
bindgetuserinfo获取是否授权成功的用户信息

<button open-type="getUserInfo" bindgetuserinfo="getUserInfo">
	登录授权
</button>

getUserInfo(data){
	console.log(data)
}
```

## 授权 wx.authorize

>提前向用户发起授权请求。调用后会立刻弹窗询问用户是否同意授权小程序使用某项功能或获取用户的某些数据

```
1.可以通过 wx.getSetting 获取当前用户的设置，返回值中只会出现小程序已经向用户请求过的权限

wx.getSetting({
  success(res) {
    if (!res.authSetting['scope.userInfo']) {
      wx.authorize({
        scope: 'scope.userInfo',
        success () {
          wx.getUserInfo()
        }
      })
    }
  }
})
```