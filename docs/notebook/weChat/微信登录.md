 ## 登录流程

```
先wx.checkSession检查登录态是否过期
1.wx.login()获取返回的code
2.wx.request()把code发送给后端
3.后端拿着appid,appsecret,code请求微信接口服务
4.微信后台返回session_key，openid等给后端，然后再返回token给前端
5.前端拿到token后记录用户的登录状态，登录成功
```

**session_key用来解密微信加密数据，不能明文传给前端**

## 登录

```
login(){
1. wx.login({
	  success: (result) => {
		console.log(result)  //有返回code，可以传给后端
		if(result.code){
			
		  2. wx.request({
			url: 'url',
			data:{'code':result.code},
			success(res){
				const result = res.date;
				//会拿到后端返回的token
				
				3. if(result.code === 成功的状态码){
						try{
							wx.setStorageSync('token',result.data.token)  //把token存到本地
						}catch(e){
							console.log(e)
						}
					}else{
						console.log('失败')
					}
			}
		  })
		  
		}
	  },
	  fail: (res) => {},
	  complete: (res) => {},
	})
}



wx.checkSession({     //检查登录态session_key是否过期
	success: function(res) {
		if(wx.getStorageSync('token')){   //getStorageSync()同步的方法
			//session没有过期并且本地缓存有token，也就是token没有过期，
			//不用调用登录接口获取token
		}else{
			//本地存储没token时
			wx.getSetting({
			  success(res) {
				if (res.authSetting['scope.userInfo']) {    //点击button授权后，才能调用wx.getUserInfo()
					//重新执行登录方法
				}else{
					让用户点击授权再登录
				}
			  }
			})
		}
	},
	fail(){  //session_key过期
		wx.getSetting({
		  success(res) {
			if (res.authSetting['scope.userInfo']) {   
				//有授权直接调用wx.login等流程
			}else{
				//没授权就让用户点击授权再执行wx.login等流程
			}
		  }
		})
	}
})
```

## button点击授权，获取用户信息

```
填写open-type="getUserInfo"才会有弹窗询问是否允许获取你的信息
bindgetuserinfo获取是否授权成功的用户信息

<button open-type="getUserInfo" bindgetuserinfo="getUserInfo">
	登录授权
</button>

//授权后登录执行的函数
getUserInfo(event){
	if(event.detail.userInfo){   //里面为获取token的方法，可以抽离出去
		const _this = this;
		1. wx.login({
		  success: (result) => {
			console.log(result)  //有返回code，可以传给后端
			if(result.code){
				
			  2. wx.request({
				url: 'url',
				data:{'code':result.code},
				success(res){
					const result = res.date;
					//会拿到后端返回的token
					
					3. if(result.code === 成功的状态码){
							try{
								wx.setStorageSync('token',result.data.token)  //把token存到本地
							}catch(e){
								console.log(e)
							}
							_this.setData({})
						}else{
							console.log('失败')
						}
					 
				}
			  })
			}
		  },
		  fail: (res) => {},
		  complete: (res) => {},
		})
	}
}

//上面用button点击出现弹窗允许获取用户信息授权过后，才能调用wx.getUserInfo(),不然返回错误信息，没授权，
现在微信版本wx.getUserInfo()不会自动出现授权弹窗,wx.authorize()也没有弹窗

//用户信息授权成功再执行下面代码,用于数据的展示
//在onShow生命周期里

onShow(){
	const _this = this;
	//检查登录态session_key是否过期
	wx.checkSession({       //有可能没授权,checkSession也能成功(只要调用wx.login()就不会过期，不管有没有授权)
		success: function(res) {
			if(wx.getStorageSync('token')){   //getStorageSync()同步的方法
				//session没有过期并且本地缓存有token，也就是token没有过期，
				//不用调用登录接口获取token
				
			    //授权过后才能调用，现在微信版本wx.getUserInfo()不会自动出现授权弹窗
			    wx.getUserInfo({
					lang:'zh_CN'
					success: (result) => {console.log(res)},
			    }) 
							
			}else{  //本地存储没token时
				wx.getSetting({
				  success(res) {
					if (res.authSetting['scope.userInfo']) {    //点击button授权后，才能调用wx.getUserInfo()
						//重新执行登录方法
					}else{
						让用户点击授权再登录
					}
				  }
				})
			}
		},
		fail(){  //session_key过期
			wx.getSetting({
			  success(res) {
				if (res.authSetting['scope.userInfo']) {   
					//有授权直接调用wx.login等流程,之后再那wx.getUserInfo
				}else{
					//没授权就让用户点击授权再执行wx.login等流程
				}
			  }
			})
		}
	})
}
```

## 授权 wx.authorize

>提前向用户发起授权请求。调用后会立刻弹窗询问用户是否同意授权小程序使用某项功能或获取用户的某些数据

```
1.可以通过 wx.getSetting 获取当前用户的授权设置，返回值中只会出现小程序已经向用户请求过的权限

wx.getSetting({
  success(res) {
    if (!res.authSetting['scope.record']) {
      wx.authorize({
        scope: 'scope.record',
        success () {
		   
        }
      })
    }
  }
})
```

**注意**

```
1. wx.authorize({scope: "scope.userInfo"})，不会弹出授权窗口，请使用 <button open-type="getUserInfo"/>
2. 需要授权 scope.userLocation、scope.userLocationBackground 时必须配置地理位置用途说明
```


